<div class="card">
    <div class="header">
        <h4 class="title">Customers</h4>
        <p class="category">Here are listed all the customers</p>
    </div>
      <div class="content table-responsive table-full-width">
        <table id="customers" class="table table-hover table-striped">
            <thead>
              <th>User id</th>
              <th>Name</th>
              <th>Lastname</th>
              <th>Address</th>
              <th>Email</th>
              <th>Edit</th>
              <th>Delete</th>
            </thead>
            <tbody id="customersBody">
              <td style="text-align: center" colspan="7"><img style="width: 50px; height: auto" src="assets/img/loader.gif"></td>

            </tbody>
        </table>
      </div>
</div>

<div class="card">
    <div class="header">
        <h4 class="title">Vendors</h4>
        <p class="category">Here are listed all the vendors</p>
    </div>
      <div class="content table-responsive table-full-width">
        <table id="vendors" class="table table-hover table-striped">
            <thead>
              <th>User id</th>
              <th>Name</th>
              <th>Lastname</th>
              <th>Address</th>
              <th>Email</th>
              <th>Company</th>
              <th>Edit</th>
              <th>Delete</th>
            </thead>
            <tbody id="vendorsBody">
              <td style="text-align: center" colspan="8"><img style="width: 50px; height: auto" src="assets/img/loader.gif"></td>
            </tbody>
        </table>
      </div>
</div>




<button id ="mainButton" type="button" class="btn btn-info btn-fill pull-left" onclick="add_user()">Add new user</button>



<!-- Editing Vendor -->
<div class="modal fade" id="vendorModal" tabindex="-1" role="dialog" aria-labelledby="vendorModalLable" aria-hidden="true">
<div class="modal-dialog" role="document">
<div class="modal-content">
  <div class="modal-header">
    <h5 class="modal-title" id="vendorModalLable">Edit vendor</h5>
    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
      <span aria-hidden="true">&times;</span>
    </button>
  </div>
  <form id="vendor-form">
      <div class="modal-body">
        <input id="vendorId" name="vendorId" type="hidden">
            <div class="form-group">
                <label>First Name</label>
                <input id = "vendorName" name = "name" type="text" class="form-control" placeholder="Company" value="Mike">
            </div>
            <div class="form-group">
                <label>Last Name</label>
                <input id = "vendorLastname" name = "lastname" type="text" class="form-control" placeholder="Last Name" value="Andrew">
            </div>
            <div class="form-group">
                <label>Email address</label>
                <input id = "vendorEmail" name = "email" type="email" class="form-control" placeholder="Email">
            </div>
            <div class="form-group">
                <label>Address</label>
                <input id = "vendorAddress" name = "address" type="text" class="form-control" placeholder="Address">
            </div>
            <div id="company_input" class="form-group">
                <label>Company</label>
                <input id = "vendorCompany" name = "company" type="text" class="form-control" placeholder="Company" value="Creative Code Inc.">
            </div>
            <div class="form-group">
              <button id = "vendorChangePasswordButton" type="button" class="btn btn-info btn-fill">Change password</button>
            </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      <button type="submit" class="btn btn-primary">Update</button>
    </div>
    </div>
  </form>
</div>
</div>
</div>



<!-- Add user modal -->
<div class="modal fade" id="addUserModal" tabindex="-1" role="dialog" aria-labelledby="addUserModalLable" aria-hidden="true">
<div class="modal-dialog" role="document">
<div class="modal-content">
  <div class="modal-header">
    <h5 class="modal-title" id="addUserModalLable">Add new user</h5>
    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
      <span aria-hidden="true">&times;</span>
    </button>
  </div>
  <form id="add-user-form">
                <div class="modal-body">
                  <div id="userTypeRadio" class="form-group">
                    <label>User type</label>
                    <div class="form-check form-check-radio">
                      <label class="form-check-label">
                        <input class="form-check-input" type="radio" name="userRadioButton" id="customerRadioButton" value="customer" checked>
                        <span class="form-check-sign"></span>
                        Customer
                      </label>
                  </div>

                  <div class="form-check form-check-radio">
                    <label class="form-check-label">
                      <input class="form-check-input" type="radio" name="userRadioButton" id="vendorRadioButton" value="vendor">
                      <span class="form-check-sign"></span>
                      Vendor
                    </label>
                  </div>
                </div>
            <div class="form-group">
                <label>First Name</label>
                <input id = "newUserName" name = "name" type="text" class="form-control" value="Mike">
            </div>
            <div class="form-group">
                <label>Last Name</label>
                <input id = "newUserLastname" name = "lastname" type="text" class="form-control" value="Andrew">
            </div>
            <div class="form-group">
                <label>Email address</label>
                <input id = "newUserEmail" name = "email" type="email" class="form-control" >
            </div>
            <div class="form-group">
                <label>Address</label>
                <input id = "newUserAddress" name = "address" type="text" class="form-control" >
            </div>
            <div class="form-group">
              <label>Password</label>
              <input id="newUserPassword" name="password" type="password" class="form-control">
            </div>
            <div class="form-group">
              <label>Confirm password</label>
              <input id="newUserConfirmPassword" name="confirm_password" type="password" class="form-control">
            </div>
            <div id="newUserCompanyInput" class="form-group">

            </div>

    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      <button type="submit" class="btn btn-primary">Add user</button>
    </div>
    </div>
  </form>
</div>
</div>
</div>



<!-- Editing User -->
<div class="modal fade" id="userModal" tabindex="-1" role="dialog" aria-labelledby="userModalLable" aria-hidden="true">
<div class="modal-dialog" role="document">
<div class="modal-content">
  <div class="modal-header">
    <h5 class="modal-title" id="userModalLable">Edit user</h5>
    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
      <span aria-hidden="true">&times;</span>
    </button>
  </div>
  <form id="user-form">
      <div class="modal-body">
        <input id="userId" name="userId" type="hidden">
            <div class="form-group">
                <label>First Name</label>
                <input id = "userName" name = "name" type="text" class="form-control" placeholder="Company" value="Mike">
            </div>
            <div class="form-group">
                <label>Last Name</label>
                <input id = "userLastname" name = "lastname" type="text" class="form-control" placeholder="Last Name" value="Andrew">
            </div>
            <div class="form-group">
                <label>Email address</label>
                <input id = "userEmail" name = "email" type="email" class="form-control" placeholder="Email">
            </div>
            <div class="form-group">
                <label>Address</label>
                <input id = "userAddress" name = "address" type="text" class="form-control" placeholder="Address">
            </div>
            <div class="form-group">
              <button id = "userChangePasswordButton" type="button" class="btn btn-info btn-fill">Change password</button>
            </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      <button type="submit" class="btn btn-primary">Update</button>
    </div>
    </div>
  </form>
</div>
</div>
</div>

<!-- Change password modal-->
<div class="modal fade" id="changePasswordModal" tabindex="-1" role="dialog" aria-labelledby="productModalLable" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="changePasswordModalLable" >Change password</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <form id="change-password-form" action="" method="" novalidate="">
        <div class="modal-body">
          <input id="id" name="id" type="hidden">
          <div class="form-group">
            <label>New passwrod</label>
            <input id="new_password" name="new_password" type="password" class="form-control">
          </div>

          <div class="form-group">
            <label>Confirm password</label>
            <input id="confirm_password" name="confirm_password" type="password" class="form-control">
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            <button type="submit" class="btn btn-primary">Change Password</button>
          </div>
      </form>
    </div>
  </div>
</div>

<script type="text/javascript">
  $(document).ready(function(){
    $("#change-password-form").validate({
        rules: {
          new_password: {
            required : true,
            minlength: 4,
            maxlength: 10
          },

          confirm_password: {
            required : true,
            equalTo: "#new_password"
          }
        },

        messages: {
          new_password: {
            minlength: "The password must be longer than 4",
            maxlength: "The password must be shorter than 10"
          },

          confirm_password: {
            equalTo: "Enter Confirm Password Same as Password"
          }

        },

        submitHandler: function(form){
          $.ajax({
            url: 'granApp.api/password/' + $('#change-password-form input[name="id"]').val(),
            type: 'PUT',
            headers: {
                'Bearer-Jwt': localStorage.getItem('userToken')
            },
            contentType: 'application/json; charset=utf-8',
            data: JSON.stringify(objectifyForm($('#change-password-form'))),
            success: function (jqXHR) {
                  toastr.success('Successfully updated password');
                  $('#changePasswordModal').modal('toggle');
                },
                error: function (error) {
                  if (error.status == 403){
                    window.location="login.html";
                  }else{
                    toastr.error(error.responseJSON.msg);
                  }
                }
          });
        }
    });


    $("#user-form").validate({
        rules: {
          name: {
            required : true,
            minlength: 3,
            maxlength: 15
          },

          lastname: {
            required : true,
            minlength: 3,
            maxlength: 15
          },

          email: {
            required : true
          },

          address: {
            required : true,
            minlength: 3,
            maxlength: 10
          }
        },

        messages: {
          name: {
            minlength: "Your name must be at least 3 characters long",
            maxlength: "Your name must be less than 15 characters long"
          },

          lastname: {
            minlength: "Your lastname must be at least 3 characters long",
            maxlength: "Your lastname must be less than 15 characters long"
          },

          address: {
            minlength: "Your address must be at least 3 characters long",
            maxlength: "Your address must be less than 15 characters long"
          }

        },

        submitHandler: function(form){
            $.ajax({
              url: 'granApp.api/user/' + $('#user-form input[name="userId"]').val(),
              type: 'PUT',
              headers: {
                  'Bearer-Jwt': localStorage.getItem('userToken')
              },
              contentType: 'application/json; charset=utf-8',
              data: JSON.stringify(objectifyForm($('#user-form'))),
              success: function (jqXHR) {
                    toastr.success('Successfully updated info');
                    $('#userModal').modal('toggle');
                    getCustomers();

                  },
                  error: function (error) {
                    if (error.status == 403){
                      window.location="login.html";
                    }else{
                      toastr.error(error.responseJSON.msg);
                    }
                  }
            });
        }
    });


    $("#vendor-form").validate({
        rules: {
          name: {
            required : true,
            minlength: 3,
            maxlength: 15
          },

          lastname: {
            required : true,
            minlength: 3,
            maxlength: 15
          },

          email: {
            required : true
          },

          company: {
            required : true,
            minlength: 2,
            maxlength: 10
          },

          address: {
            required : true,
            minlength: 3,
            maxlength: 10
          }
        },

        messages: {
          name: {
            minlength: "Your name must be at least 3 characters long",
            maxlength: "Your name must be less than 15 characters long"
          },

          lastname: {
            minlength: "Your lastname must be at least 3 characters long",
            maxlength: "Your lastname must be less than 15 characters long"
          },

          company: {
            minlength: "Your company name must be at least 2 characters long",
            maxlength: "Your company name must be less than 15 characters long"
          },

          address: {
            minlength: "Your address must be at least 3 characters long",
            maxlength: "Your address must be less than 15 characters long"
          }

        },

        submitHandler: function(form){
            $.ajax({
              url: 'granApp.api/vendors/' + $('#vendor-form input[name="vendorId"]').val(),
              type: 'PUT',
              headers: {
                  'Bearer-Jwt': localStorage.getItem('userToken')
              },
              contentType: 'application/json; charset=utf-8',
              data: JSON.stringify(objectifyForm($('#vendor-form'))),
              success: function (jqXHR) {
                    toastr.success('Successfully updated info');
                    $('#vendorModal').modal('toggle');
                    getVendors();
                  },
                  error: function (error) {
                    if (error.status == 403){
                      window.location="login.html";
                    }else{
                      toastr.error(error.responseJSON.msg);
                    }
                  }
            });

        }
    });

    $("#add-user-form").validate({
        rules: {
          name: {
            required : true,
            minlength: 3,
            maxlength: 15
          },

          lastname: {
            required : true,
            minlength: 3,
            maxlength: 15
          },

          email: {
            required : true
          },

          company: {
            required : true,
            minlength: 2,
            maxlength: 10
          },

          address: {
            required : true,
            minlength: 3,
            maxlength: 10
          },


        new_password: {
          required : true,
          minlength: 4,
          maxlength: 10
        },

        confirm_password: {
          required : true,
          equalTo: "#newUserPassword"
        }
      },

        messages: {
          name: {
            minlength: "Your name must be at least 3 characters long",
            maxlength: "Your name must be less than 15 characters long"
          },

          lastname: {
            minlength: "Your lastname must be at least 3 characters long",
            maxlength: "Your lastname must be less than 15 characters long"
          },

          company: {
            minlength: "Your company name must be at least 2 characters long",
            maxlength: "Your company name must be less than 15 characters long"
          },

          address: {
            minlength: "Your address must be at least 3 characters long",
            maxlength: "Your address must be less than 15 characters long"
          },

          new_password: {
            minlength: "The password must be longer than 4",
            maxlength: "The password must be shorter than 10"
          },

          confirm_password: {
            equalTo: "Enter Confirm Password Same as Password"
          }

        },

        submitHandler: function(form){
            if($('#vendorRadioButton').is(':checked')) {
            $.ajax({
              url: 'granApp.api/register/vendors',
              type: 'POST',
              headers: {
                  'Bearer-Jwt': localStorage.getItem('userToken')
              },
              contentType: 'application/json; charset=utf-8',
              data: JSON.stringify(objectifyForm($("#add-user-form"))),
              success: function (jqXHR) {

                    toastr.success('Successfully added user');

                    getVendors();
                  },
                  error: function (error) {
                    if (error.status == 403){
                      window.location="login.html";
                    }else{
                      toastr.error(error.responseJSON.msg);
                    }
                  }
            });
          }else if($('#customerRadioButton').is(':checked')){
            $.ajax({
              url: 'granApp.api/register/customers',
              type: 'POST',
              headers: {
                  'Bearer-Jwt': localStorage.getItem('userToken')
              },
              contentType: 'application/json; charset=utf-8',
              data: JSON.stringify(objectifyForm($("#add-user-form"))),
              success: function (jqXHR) {

                    toastr.success('Successfully added user');

                    getVendors();
                  },
                  error: function (error) {
                    if (error.status == 403){
                      window.location="login.html";
                    }else{
                      toastr.error(error.responseJSON.msg);
                    }
                  }
            });

          }
        }
    });

  });



 $('#vendorRadioButton').click(function(){
   html='';
   html+='<label id="companyTitle">Company</label>';
   html+= '<input id = "vendorCompany" name = "company" type="text" class="form-control" >';
   $("#newUserCompanyInput").html(html);
});

$('#customerRadioButton').click(function(){
  $("#newUserCompanyInput").html('');
});






  getVendors();
  getCustomers();

  function add_user(){
    $('#newUserName').val('');
    $('#newUserLastname').val('');
    $('#newUserEmail').val('');
    $('#newUserAddress').val('');
    $('#newUserAddress').val('');
    $('#newUserConfirmPassword').val('');
    $('#addUserModal').modal('toggle');
  }

  function changePassword(id){
    $('#changePasswordModal').modal('toggle');
    $('#change-password-form input[name="id"]').val(id);
  }

  function getVendors(){
    $.ajax({
            url: 'granApp.api/vendors/',
            type: 'GET',
            dataType: 'json',
            headers: {
                'Bearer-Jwt': localStorage.getItem('userToken')
            },
            contentType: 'application/json; charset=utf-8',
            success: function (data) {
              var html = '';
              for(var i = 0; i < data.length; i++){
                html += '<tr><td>' + data[i].id + '</td>';
                html += '<td>' + data[i].name + '</td>';
                html += '<td>' + data[i].lastname + '</td>';
                html += '<td>' + data[i].address + '</td>';
                html += '<td>' + data[i].email + '</td>';
                html += '<td>' + data[i].company + '</td>';
                html += '<td><button type="button" class="btn btn-info btn-fill" onclick="edit_vendor(' + data[i].id + ')">Edit</button></td>';
                html += '<td><button type="button" class="btn btn-primary" onclick="deleteUser(' + data[i].id + ')">Delete</button></td></tr>';

              }
              $("#vendorsBody").html(html);
              $('#vendors').DataTable();
            },
            error: function (error) {
              if (error.status == 403){
                window.location="login.html";
              }else{
                toastr.error(error.responseJSON.msg);
              }
            }
        });
      }

      function getCustomers(){
        $.ajax({
                url: 'granApp.api/customers/',
                type: 'GET',
                dataType: 'json',
                headers: {
                    'Bearer-Jwt': localStorage.getItem('userToken')
                },
                contentType: 'application/json; charset=utf-8',
                success: function (data) {
                  var html = '';
                  for(var i = 0; i < data.length; i++){
                    html += '<tr><td>' + data[i].id + '</td>';
                    html += '<td>' + data[i].name + '</td>';
                    html += '<td>' + data[i].lastname + '</td>';
                    html += '<td>' + data[i].address + '</td>';
                    html += '<td>' + data[i].email + '</td>';
                    html += '<td><button type="button" class="btn btn-info btn-fill" onclick="edit_user(' + data[i].id + ')">Edit</button></td>';
                    html += '<td><button type="button" class="btn btn-primary" onclick="deleteUser(' + data[i].id + ')">Delete</button></td></tr>';

                  }
                  $("#customersBody").html(html);
                  $('#customers').DataTable();
                },
                error: function (error) {
                  if (error.status == 403){
                    window.location="login.html";
                  }else{
                    toastr.error(error.responseJSON.msg);
                  }
                }
            });
          }


          function edit_vendor(id){
              $.ajax({
                      url: 'granApp.api/vendors/' + id,
                      type: 'GET',
                      dataType: 'json',
                      headers: {
                          'Bearer-Jwt': localStorage.getItem('userToken')
                      },
                      contentType: 'application/json; charset=utf-8',
                      success: function (data) {


                        for(var i = 0; i < data.length; i++){
                          $('#vendorId').val(id);
                          $('#vendorName').val(data[i].name);
                          $('#vendorLastname').val(data[i].lastname);
                          $('#vendorEmail').val(data[i].email);
                          $('#vendorCompany').val(data[i].company);
                          $('#vendorAddress').val(data[i].address);
                          $('#vendorChangePasswordButton').attr('onclick', 'changePassword('+ id +')');
                        }

                          $('#vendorModal').modal('toggle');
                      },
                      error: function (error) {
                        if (error.status == 403){
                          window.location="login.html";
                        }else{
                          toastr.error(error.responseJSON.msg);
                      }
                  }
            });
          }

          function edit_user(id){
              $.ajax({
                      url: 'granApp.api/user/' + id,
                      type: 'GET',
                      dataType: 'json',
                      headers: {
                          'Bearer-Jwt': localStorage.getItem('userToken')
                      },
                      contentType: 'application/json; charset=utf-8',
                      success: function (data) {


                        for(var i = 0; i < data.length; i++){
                          $('#userId').val(id);
                          $('#userName').val(data[i].name);
                          $('#userLastname').val(data[i].lastname);
                          $('#userEmail').val(data[i].email);
                          $('#userAddress').val(data[i].address);
                          $('#userChangePasswordButton').attr('onclick', 'changePassword('+ id +')');
                        }

                          $('#userModal').modal('toggle');
                      },
                      error: function (error) {
                        if (error.status == 403){
                          window.location="login.html";
                        }else{
                          toastr.error(error.responseJSON.msg);
                      }
                  }
            });
          }

      function deleteUser(id){
        if(confirm('Do you want to delete this user?')){
        $.ajax({
          method: "DELETE",
          url: 'granApp.api/user/' + id,
          headers: {
              'Bearer-Jwt': localStorage.getItem('userToken')
          },
          success: function() {
              toastr.success('Successfully deleted user');

              getVendors();
              getCustomers();
          },
          error: function (error) {
            if (error.status == 403){
              window.location="login.html";
            }else{
              toastr.error(error.responseJSON.msg);
            }
          }
      });

    }
  }



</script>
